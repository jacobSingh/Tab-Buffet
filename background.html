<script>
  chrome.tabs.onRemoved.addListener(recordTabCount);

  chrome.tabs.onCreated.addListener(recordTabCount);

  var logging = false;
  
  /**
   * Records the number of open tabs in localstorage.
   */
  function recordTabCount() {
    chrome.windows.getAll({ populate: true }, function(windowList) {
      var tabCount = 0;
      var d = new Date()
      var localOffset = d.getTimezoneOffset() * 60000;
      var utcTime = d.getTime() + localOffset
      for (var i = 0; i < windowList.length; i++) {
        tabCount += windowList[i].tabs.length
      }
      setItem('tabCount::' + utcTime, tabCount);
    });
  }

  /**
   * Returns a filtered dataset of all records.  Each element in the array
   * contains an array where the first element it the timestamp it was recorded (in UTC)
   * and the second element is the # of tabs open at that time.
   */
  function getData() {
    var records = new Array();
    var r = /^tabCount::([0-9]+)/g;
    for (i in window.localStorage) {
      if (m = r.exec(i)) {
        records.push([parseFloat(m[1]), parseFloat(window.localStorage[i])]);
      }
    }
    records.sort(sortByTime)
    return records;
  }

  function sortByTime(a,b) {
    if (a[0] > b[0]) {
      return 1;
    } else {
      return -1;
    }
    return 0;
  }

  function resetData() {
    window.localStorage.clear();
  }

  //sets the item in the localstorage
  function setItem(key, value) {
    try {
      log("Inside setItem:" + key + ":" + value);
      window.localStorage.removeItem(key);
      window.localStorage.setItem(key, value);
    } catch(e) {
      log("Error inside setItem");
      log(e);
    }
    log("Return from setItem" + key + ":" +  value);
  }

  //Gets the item from local storage with the specified
  //key
  function getItem(key) {
    var value;
    log('Get Item:' + key);
    try {
      value = window.localStorage.getItem(key);
    } catch(e) {
      log("Error inside getItem() for key:" + key);
      log(e);
      value = "null";
    }
    log("Returning value: " + value);
    return value;
  }
  
  function log(txt) {
  	if (logging) {
      console.log(txt);
   	}
  }
</script>